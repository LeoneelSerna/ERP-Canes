<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="dashboard-container">
    <div class="welcome-card">
      <h1 class="dashboard-title">¬°Bienvenido!</h1>
      <p class="user-email" id="userEmail">Cargando...</p>
      <p class="dashboard-subtitle">Gestiona tu cuenta y actividades</p>
      <div style="margin: 2rem 0;">
        <a href="/admin" class="btn-admin">
          üõ†Ô∏è Ir a Admin Panel
        </a>
      </div>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-number" id="userId">0</span>
        <div class="stat-label">ID Usuario</div>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalUsers">-</span>
        <div class="stat-label">Total Usuarios</div>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="sessionTime">0</span>
        <div class="stat-label">Sesi√≥n Activa</div>
      </div>
    </div>
    
    <div class="logout-section">
      <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>
  
  <!-- Secci√≥n Perros -->
  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-number" id="totalPerros">0</span>
      <div class="stat-label">Total Perros</div>
    </div>
  </div>
  </div>
  <!-- Gesti√≥n Perros K9 -->
<section class="welcome-card" style="margin-top: 2rem;">
  <h3>üêï Gesti√≥n Perros K9</h3>
  
  <div style="display: flex; gap: 1rem; margin: 1rem 0;">
    <button onclick="listarPerros()" class="logout-btn" style="padding: 10px 20px;">
      üìã Listar Perros
    </button>
    <button onclick="nuevoPerro()" class="logout-btn" style="padding: 10px 20px; background: #4ecca3;">
      ‚ûï Nuevo Perro
    </button>
  </div>
  
  <div id="perros-lista" style="margin-top: 1rem;"></div>
</section>

</div>

<!-- Modal Nuevo Perro (OCULTO por default) -->
<div id="modalNuevoPerro" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚ûï Nuevo Perro K9</h3>
      <button onclick="cerrarModal()" class="close-btn">&times;</button>
    </div>
    
    <form id="formNuevoPerro">
      <div class="input-group">
        <label>Microchip *</label>
        <input type="text" id="microchip" required maxlength="50">
      </div>
      
      <div class="input-group">
        <label>Nombre *</label>
        <input type="text" id="nombre" required maxlength="100">
      </div>
      
      <div class="input-group">
        <label>Raza</label>
        <input type="text" id="raza" maxlength="100">
      </div>
      
      <div class="input-row">
        <div class="input-group">
          <label>Fecha Nacimiento</label>
          <input type="date" id="fecha_nac">
        </div>
        <div class="input-group">
          <label>Sexo</label>
          <select id="sexo">
            <option value="">Seleccionar</option>
            <option value="M">Macho</option>
            <option value="H">Hembra</option>
          </select>
        </div>
      </div>
      
      <div class="input-row">
        <div class="input-group">
          <label>Especialidad</label>
          <select id="especialidad" required>
            <option value="">Seleccionar</option>
            <option value="verde">Verde</option>
            <option value="narcoticos">Narc√≥ticos</option>
            <option value="explosivos">Explosivos</option>
            <option value="cadaver">Cad√°ver</option>
            <option value="doble">Doble</option>
            <option value="otros">Otros</option>
          </select>
        </div>
        <div class="input-group">
          <label>Ubicaci√≥n *</label>
          <select id="ubicacion" required>
            <option value="">Seleccionar</option>
            <option value="Toluca">Toluca</option>
            <option value="Chihuahua">Chihuahua</option>
            <option value="Tijuana">Tijuana</option>
            <option value="NMK9">NMK9</option>
            <option value="Servicio">Servicio</option>
          </select>
        </div>
      </div>
      
      <div class="input-group">
        <label>Inventario *</label>
        <select id="inventario" required>
          <option value="">Seleccionar</option>
          <option value="entrenamiento">Entrenamiento</option>
          <option value="servicio">Servicio</option>
          <option value="donacion">Donaci√≥n</option>
          <option value="venta">Venta</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>Notas</label>
        <textarea id="notas" rows="3" maxlength="1000"></textarea>
      </div>
      
      <div class="modal-actions">
        <button type="button" onclick="cerrarModal()" class="btn-cancel">Cancelar</button>
        <button type="submit" class="logout-btn">üíæ Guardar Perro</button>
      </div>
    </form>
  </div>
</div>

<!--Scripts a Ejecutar-->
  <script>
    async function loadDashboardData() {
      try {
        const res = await fetch('/api/auth/users');
        const data = await res.json();
        
        const sessionRes = await fetch('/api/session');
        const session = await sessionRes.json();
        
        document.getElementById('userEmail').textContent = session.email;
        document.getElementById('userId').textContent = session.id.slice(-6) || 'N/A';
        document.getElementById('totalUsers').textContent = data.count;
        document.getElementById('sessionTime').textContent = 'Activa ‚úì';
        
      } catch (error) {
        console.error('Error dashboard:', error);
      }
    }
    
    async function logout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (error) {
        alert('Error al cerrar sesi√≥n');
      }
    }
    
    loadDashboardData();
    setInterval(loadDashboardData, 30000);
    //Bloque Lista perros
    async function cargarPerros() {
      const res = await fetch('/api/perros');
      const data = await res.json();
      document.getElementById('totalPerros').textContent = data.data?.length || 0;
    }

    let perrosData = [];

    async function listarPerros() {
      try {
        const res = await fetch('/api/perros');
        perrosData = await res.json();
        
        const lista = document.getElementById('perros-lista');
        lista.innerHTML = `
          <h4>üìä ${perrosData.data?.length || 0} perros registrados</h4>
          <div style="display: grid; gap: 1rem; margin-top: 1rem;">
            ${perrosData.data?.map(perro => `
              <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #e94560;">
                <strong>${perro.nombre}</strong> (${perro.microchip})<br>
                <small>${perro.raza} ‚Ä¢ ${perro.ubicacion} ‚Ä¢ ${perro.inventario}</small>
                <br><small>${perro.notas || 'Sin notas'}</small>
              </div>
            `).join('') || '<p>No hay perros</p>'}
          </div>
        `;
      } catch (error) {
        document.getElementById('perros-lista').innerHTML = `<p style="color: #ff6b6b;">‚ùå Error: ${error.message}</p>`;
      }
    }

    function abrirModal() {
      document.getElementById('modalNuevoPerro').style.display = 'flex';
    }

    function cerrarModal() {
      document.getElementById('modalNuevoPerro').style.display = 'none';
      document.getElementById('formNuevoPerro').reset();
    }

    document.getElementById('formNuevoPerro').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        microchip: document.getElementById('microchip').value,
        nombre: document.getElementById('nombre').value,
        raza: document.getElementById('raza').value,
        fecha_nac: document.getElementById('fecha_nac').value,
        color: '',
        sexo: document.getElementById('sexo').value,
        especialidad: document.getElementById('especialidad').value,
        ubicacion: document.getElementById('ubicacion').value,
        inventario: document.getElementById('inventario').value,
        notas: document.getElementById('notas').value
      };
      
      try {
        const res = await fetch('/api/perros', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        if (res.ok) {
          alert('‚úÖ Perro creado exitosamente!');
          cerrarModal();
          listarPerros();// Recargar listas
          cargarPerros();// Recargar listas
        } else {
          const error = await res.json();
          alert('‚ùå Error: ' + error.error);
        }
      } catch (error) {
        alert('‚ùå Error conexi√≥n: ' + error.message);
      }
    });

    function nuevoPerro() {
      abrirModal();
    }


    // Cargar al iniciar
    listarPerros();
    cargarPerros();
  </script>
</body>
</html>
