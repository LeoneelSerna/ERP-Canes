<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">  
  <title>Dashboard K9</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0f1419">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">  
  <link rel="stylesheet" href="style.css">
  <script src="/js/common.js"></script>
  <script src="/js/api.js"></script>
</head>
<body>
  <div class="dashboard-container">
    <div class="welcome-card">
      <h1 class="dashboard-title">¬°Bienvenido!</h1>
      <p class="user-email" id="userEmail">Cargando...</p>
      <p class="dashboard-subtitle">Gestiona tu cuenta y actividades</p>
      <div style="margin: 2rem 0;">
        <a href="/admin" class="btn-admin">üõ†Ô∏è Ir a Admin Panel</a>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-number" id="userId">0</span>
        <div class="stat-label">ID Usuario</div>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalUsers">-</span>
        <div class="stat-label">Total Usuarios</div>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalPerros">0</span>
        <div class="stat-label">Total Perros</div>
      </div>
    </div>

    <!-- Gesti√≥n Perros K9 -->
    <section class="welcome-card" style="margin-top: 2rem;">
      <h3>üêï Gesti√≥n Perros K9</h3>
      
      <div style="display: flex; gap: 1rem; margin: 1rem 0;">
        <button onclick="listarPerros()" class="logout-btn" style="padding: 10px 20px;">
          üìã Listar Perros
        </button>
        <button onclick="nuevoPerro()" class="logout-btn" style="padding: 10px 20px; background: #4ecca3;">
          ‚ûï Nuevo Perro
        </button>
      </div>
      
      <div id="perros-lista" style="margin-top: 1rem;"></div>
    </section>
  </div>

<!-- Modal Nuevo Perro -->
<div id="modalNuevoPerro" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚ûï Nuevo Perro K9</h3>
      <button onclick="cerrarModal()" class="close-btn">&times;</button>
    </div>
    
    <form id="formNuevoPerro" enctype="multipart/form-data">
      <div class="input-group">
        <label>Microchip *</label>
        <input type="text" id="microchip" required maxlength="50">
      </div>
      
      <div class="input-group">
        <label>Nombre *</label>
        <input type="text" id="nombre" required maxlength="100">
      </div>
      
      <div class="input-group">
        <label>Raza</label>
        <input type="text" id="raza" maxlength="100">
      </div>
      
      <div class="input-row">
        <div class="input-group">
          <label>Fecha Nacimiento</label>
          <input type="date" id="fecha_nac">
        </div>
        <div class="input-group">
          <label>Sexo</label>
          <select id="sexo">
            <option value="">Seleccionar</option>
            <option value="M">Macho</option>
            <option value="H">Hembra</option>
          </select>
        </div>
      </div>
      
      <div class="input-row">
        <div class="input-group">
          <label>Especialidad</label>
          <select id="especialidad">
            <option value="">Seleccionar</option>
            <option value="verde">Verde</option>
            <option value="narcoticos">Narc√≥ticos</option>
            <option value="explosivos">Explosivos</option>
            <option value="cadaver">Cad√°ver</option>
            <option value="doble">Doble</option>
            <option value="otros">Otros</option>
          </select>
        </div>
        <div class="input-group">
          <label>Ubicaci√≥n *</label>
          <select id="ubicacion" required>
            <option value="">Seleccionar</option>
            <option value="Toluca">Toluca</option>
            <option value="Chihuahua">Chihuahua</option>
            <option value="Tijuana">Tijuana</option>
            <option value="NMK9">NMK9</option>
            <option value="Servicio">Servicio</option>
          </select>
        </div>
      </div>
      
      <div class="input-group">
        <label>Inventario *</label>
        <select id="inventario" required>
          <option value="">Seleccionar</option>
          <option value="entrenamiento">Entrenamiento</option>
          <option value="servicio">Servicio</option>
          <option value="donacion">Donaci√≥n</option>
          <option value="venta">Venta</option>
        </select>
      </div>
    
      <!-- Foto -->
      <div class="input-group">
        <label>üì∑ Foto del Perro</label>
        <input type="file" id="foto" accept="image/*">
        <small style="color: rgba(255,255,255,0.6);">M√°x. 5MB (jpg, png, gif, webp)</small>
      </div>
      
      <div class="input-group">
        <label>Notas</label>
        <textarea id="notas" rows="3" maxlength="1000"></textarea>
      </div>
      
      <div class="modal-actions">
        <button type="button" onclick="cerrarModal()" class="btn-cancel">Cancelar</button>
        <button type="submit" class="logout-btn">üíæ Guardar Perro</button>
      </div>
    </form>
  </div>
</div>
  
  <script>
    // ‚îÄ‚îÄ‚îÄ VERIFICAR SESI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (async function() {
      const token = localStorage.getItem('k9_token');
      if (!token) { window.location.href = '/'; return; }

      try {
        const res = await apiFetch('/api/auth/verify', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if (!data.valid) {
          localStorage.removeItem('k9_token');
          localStorage.removeItem('k9_user');
          window.location.href = '/';
        }
      } catch {
        window.location.href = '/';
      }
    })();

    //INICIO DE SCRIPTS

    // ========== INICIALIZAR DASHBOARD (usa funciones de common.js) ==========
    (async () => {
      await loadSessionData();    // De common.js
      await loadTotalUsers();     // De common.js
      await cargarPerros();
      listarPerros();
    })();

    // Actualizar cada 30 segundos
    setInterval(async () => {
      await loadSessionData();
      await loadTotalUsers();
    }, 30000);

    // ========== FUNCIONES ESPEC√çFICAS DEL DASHBOARD ==========
    let perrosData = [];

    async function cargarPerros() {
      const res = await apiFetch('/api/perros');
      const data = await res.json();
      document.getElementById('totalPerros').textContent = data.data?.length || 0;
    }

    async function listarPerros() {
      try {
        const res = await apiFetch('/api/perros');
        perrosData = await res.json();
        
        const lista = document.getElementById('perros-lista');
        lista.innerHTML = `
          <h4>üìä ${perrosData.data?.length || 0} perros registrados</h4>
          <div style="display: grid; gap: 1rem; margin-top: 1rem;">
            ${perrosData.data?.map(perro => `
              <div 
                onclick="irPerfilPerro('${perro.microchip}')"
                style="
                  background: rgba(255,255,255,0.1); 
                  padding: 1rem; 
                  border-radius: 8px; 
                  border-left: 4px solid #e94560;
                  cursor: pointer;
                  transition: all 0.2s;
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'"
                onmouseout="this.style.transform='none'; this.style.boxShadow='none'"
              >
                <strong>${perro.nombre}</strong> (${perro.microchip})<br>
                <small>${perro.raza || ''} ‚Ä¢ ${perro.ubicacion || ''} ‚Ä¢ ${perro.inventario || ''}</small>
                <br><small>${perro.notas || 'Sin notas'}</small>
              </div>
            `).join('') || '<p>No hay perros</p>'}
          </div>
        `;
      } catch (error) {
        document.getElementById('perros-lista').innerHTML = 
          `<p style="color: #ff6b6b;">‚ùå Error: ${error.message}</p>`;
      }
    }

    function nuevoPerro() {
      document.getElementById('modalNuevoPerro').style.display = 'flex';
    }

    function cerrarModal() {
      document.getElementById('modalNuevoPerro').style.display = 'none';
      document.getElementById('formNuevoPerro').reset();
    }

    // Submit form
    document.getElementById('formNuevoPerro').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Usar FormData para enviar archivo
  const formData = new FormData();
  formData.append('microchip', document.getElementById('microchip').value);
  formData.append('nombre', document.getElementById('nombre').value);
  formData.append('raza', document.getElementById('raza').value);
  formData.append('fecha_nac', document.getElementById('fecha_nac').value);
  formData.append('color', '');
  formData.append('sexo', document.getElementById('sexo').value);
  formData.append('especialidad', document.getElementById('especialidad').value);
  formData.append('ubicacion', document.getElementById('ubicacion').value);
  formData.append('inventario', document.getElementById('inventario').value);
  formData.append('notas', document.getElementById('notas').value);
  
  // Agregar foto si existe
  const fotoInput = document.getElementById('foto');
  if (fotoInput.files.length > 0) {
    formData.append('foto', fotoInput.files[0]);
  }
  
  try {
    const res = await apiFetch('/api/perros', {
      method: 'POST',
      body: formData  // Sin Content-Type (FormData lo maneja autom√°ticamente)
    });
    
    if (res.ok) {
      showMessage('Perro creado exitosamente!', 'success');
      cerrarModal();
      await cargarPerros();
      await listarPerros();
    } else {
      const error = await res.json();
      showMessage(error.error, 'error');
    }
  } catch (error) {
    showMessage('Error: ' + error.message, 'error');
  }
});

  </script>
</body>
</html>
