<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin K9</title>
  <link rel="stylesheet" href="style.css">
  <script src="/js/common.js"></script>
</head>
<body>
  <div class="admin-container">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="cambiarTab('perros')">üêï Perros</button>
      <button class="tab-btn" onclick="cambiarTab('entrenamientos')">üìö Entrenamientos</button>
      <button class="tab-btn" onclick="cambiarTab('vacunas')">üíâ Vacunas</button>
    </div>

    <!-- Tab Perros -->
    <div id="tab-perros" class="tab-content active">
      <div class="admin-header">
        <h3>Lista de Perros</h3>
        <button onclick="abrirModal('nuevo')" class="btn-primary">‚ûï Nuevo Perro</button>
      </div>
      
      <div class="search-bar">
        <input type="text" id="buscarPerro" placeholder="Buscar por nombre o microchip..." oninput="filtrarPerros()">
        <select id="filtroUbicacion" onchange="filtrarPerros()">
          <option value="">Todas ubicaciones</option>
          <option value="Tijuana">Tijuana</option>
          <option value="Chihuahua">Chihuahua</option>
          <option value="Toluca">Toluca</option>
        </select>
      </div>
      
      <div id="listaPerros" class="admin-table"></div>
    </div>

    <!-- Tab Entrenamientos -->
    <div id="tab-entrenamientos" class="tab-content">
      <h3>üìö Entrenamientos</h3>
      <p>Funcionalidad en desarrollo...</p>
    </div>

    <!-- Tab Vacunas -->
    <div id="tab-vacunas" class="tab-content">
      <h3>üíâ Vacunas</h3>
      <p>Funcionalidad en desarrollo...</p>
    </div>
  </div>

  <!-- Modal Nuevo Perro -->
<div id="modalNuevoPerro" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚ûï Nuevo Perro K9</h3>
      <button onclick="cerrarModal()" class="close-btn">&times;</button>
    </div>
    
    <form id="formNuevoPerro" enctype="multipart/form-data">
      <div class="input-group">
        <label>Microchip *</label>
        <input type="text" id="microchip" required maxlength="50">
      </div>
      
      <div class="input-group">
        <label>Nombre *</label>
        <input type="text" id="nombre" required maxlength="100">
      </div>
      
      <div class="input-group">
        <label>Raza</label>
        <input type="text" id="raza" maxlength="100">
      </div>
      
      <div class="input-row">
        <div class="input-group">
          <label>Fecha Nacimiento</label>
          <input type="date" id="fecha_nac">
        </div>
        <div class="input-group">
          <label>Sexo</label>
          <select id="sexo">
            <option value="">Seleccionar</option>
            <option value="M">Macho</option>
            <option value="H">Hembra</option>
          </select>
        </div>
      </div>
      
      <div class="input-row">
        <div class="input-group">
          <label>Especialidad</label>
          <select id="especialidad">
            <option value="">Seleccionar</option>
            <option value="verde">Verde</option>
            <option value="narcoticos">Narc√≥ticos</option>
            <option value="explosivos">Explosivos</option>
            <option value="cadaver">Cad√°ver</option>
            <option value="doble">Doble</option>
            <option value="otros">Otros</option>
          </select>
        </div>
        <div class="input-group">
          <label>Ubicaci√≥n *</label>
          <select id="ubicacion" required>
            <option value="">Seleccionar</option>
            <option value="Toluca">Toluca</option>
            <option value="Chihuahua">Chihuahua</option>
            <option value="Tijuana">Tijuana</option>
            <option value="NMK9">NMK9</option>
            <option value="Servicio">Servicio</option>
          </select>
        </div>
      </div>
      
      <div class="input-group">
        <label>Inventario *</label>
        <select id="inventario" required>
          <option value="">Seleccionar</option>
          <option value="entrenamiento">Entrenamiento</option>
          <option value="servicio">Servicio</option>
          <option value="donacion">Donaci√≥n</option>
          <option value="venta">Venta</option>
        </select>
      </div>
    
      <!-- Foto -->
      <div class="input-group">
        <label>üì∑ Foto del Perro</label>
        <input type="file" id="foto" accept="image/*">
        <small style="color: rgba(255,255,255,0.6);">M√°x. 5MB (jpg, png, gif, webp)</small>
      </div>
      
      <div class="input-group">
        <label>Notas</label>
        <textarea id="notas" rows="3" maxlength="1000"></textarea>
      </div>
      
      <div class="modal-actions">
        <button type="button" onclick="cerrarModal()" class="btn-cancel">Cancelar</button>
        <button type="submit" class="logout-btn">üíæ Guardar Perro</button>
      </div>
    </form>
  </div>
</div>

  

  <script>
    let todosLosPerros = [];
    let perrosFiltrados = [];
    
    // ========== CAMBIAR TAB ==========
    function cambiarTab(tabId) {
      // Desactivar todos
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Activar seleccionado
      event.target.classList.add('active');
      document.getElementById(`tab-${tabId}`).classList.add('active');
    }
    
    // ========== CARGAR PERROS ==========
    async function cargarPerros() {
      try {
        const res = await fetch('/api/perros');
        const data = await res.json();
        
        todosLosPerros = data.data || [];
        perrosFiltrados = [...todosLosPerros];
        
        renderizarTabla();
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('listaPerros').innerHTML = 
          `<div style="color:#ff6b6b;padding:2rem;">‚ùå Error: ${error.message}</div>`;
      }
    }
    
    // ========== RENDERIZAR TABLA ==========
    function renderizarTabla() {
      const lista = document.getElementById('listaPerros');
      const scrollTop = lista.scrollTop; // Preservar scroll
      
      if (perrosFiltrados.length === 0) {
        lista.innerHTML = '<div style="text-align:center;padding:3rem;color:#888;">üêï No hay perros</div>';
      } else {
        lista.innerHTML = `
          <div class="tabla-header">
            <div>Nombre / Microchip</div>
            <div>Raza</div>
            <div>Ubicaci√≥n</div>
            <div>Estado</div>
            <div>Acciones</div>
          </div>
          ${perrosFiltrados.map(perro => `
            <div class="tabla-row">
              <div class="celda-nombre">
                <strong>${perro.nombre}</strong><br>
                <small>${perro.microchip}</small>
              </div>
              <div>${perro.raza || '-'}</div>
              <div><span class="badge badge-${perro.ubicacion?.toLowerCase()}">${perro.ubicacion}</span></div>
              <div><span class="badge badge-${perro.inventario}">${perro.inventario}</span></div>
              <div>
                <button onclick="editarPerro('${perro.microchip}')" class="btn-small btn-edit">‚úèÔ∏è</button>
                <button onclick="eliminarPerro('${perro.microchip}')" class="btn-small btn-delete">üóëÔ∏è</button>
              </div>
            </div>
          `).join('')}
        `;
      }
      
      lista.scrollTop = scrollTop; // Restaurar scroll
    }
    
    // ========== FILTROS ==========
    function filtrarPerros() {
      const busqueda = document.getElementById('buscarPerro').value.toLowerCase();
      const ubicacion = document.getElementById('filtroUbicacion').value;
      
      perrosFiltrados = todosLosPerros.filter(perro => {
        const matchBusqueda = perro.nombre.toLowerCase().includes(busqueda) ||
                              perro.microchip.toLowerCase().includes(busqueda);
        const matchUbicacion = !ubicacion || perro.ubicacion === ubicacion;
        return matchBusqueda && matchUbicacion;
      });
      
      renderizarTabla();
    }
    
    // ========== MODAL ==========
    function abrirModal() {
      document.getElementById('modalNuevoPerro').style.display = 'flex';
    }
    
    function cerrarModal() {
      document.getElementById('modalNuevoPerro').style.display = 'none';
      document.getElementById('formNuevoPerro').reset();
    }
    
    // ========== FORM SUBMIT ==========
    document.getElementById('formNuevoPerro').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Usar FormData para enviar archivo
  const formData = new FormData();
  formData.append('microchip', document.getElementById('microchip').value);
  formData.append('nombre', document.getElementById('nombre').value);
  formData.append('raza', document.getElementById('raza').value);
  formData.append('fecha_nac', document.getElementById('fecha_nac').value);
  formData.append('color', '');
  formData.append('sexo', document.getElementById('sexo').value);
  formData.append('especialidad', document.getElementById('especialidad').value);
  formData.append('ubicacion', document.getElementById('ubicacion').value);
  formData.append('inventario', document.getElementById('inventario').value);
  formData.append('notas', document.getElementById('notas').value);
  
  // Agregar foto si existe
  const fotoInput = document.getElementById('foto');
  if (fotoInput.files.length > 0) {
    formData.append('foto', fotoInput.files[0]);
  }
  
  try {
    const res = await fetch('/api/perros', {
      method: 'POST',
      body: formData  // Sin Content-Type (FormData lo maneja autom√°ticamente)
    });
    
    if (res.ok) {
      showMessage('Perro creado exitosamente!', 'success');
      cerrarModal();
      await cargarPerros();
    } else {
      const error = await res.json();
      showMessage(error.error, 'error');
    }
  } catch (error) {
    showMessage('Error: ' + error.message, 'error');
  }
});

    
    // ========== BOTONES ACCI√ìN ==========
    function editarPerro(microchip) {
      showMessage('Editar ' + microchip + ' - Pr√≥ximamente', 'info');
    }
    
    function eliminarPerro(microchip) {
      if (confirm(`üóëÔ∏è ¬øEliminar ${microchip}?`)) {
        fetch(`/api/perros/${microchip}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              showMessage('Perro eliminado', 'success');
              cargarPerros();
            }
          });
      }
    }
    
    // ========== INICIALIZAR ==========
    cargarPerros();
  </script>
</body>
</html>
